# Practical Malware Analysis Chapter 6

`Lab6-01`

- What is the major code construct found in the only subroutine called by main?
![](practiacl_malware_analysis_chapter 6/PNG/6-1-0.PNG)
The called function is `sub_401000`
![](/PNG//6-1-1.PNG)
I think it's `if` condition, because she is calling windows API `InternetGetConnectedState` and store the return value in variable `[ebp+var_4]` and compare with 0 and then take a jump if the value equal zero.
---
- What is the subroutine located at 0x40105F ?
![](/PNG//6-1-2.PNG)
-he is call a function `__stbuf` with push edi and esi (he moves in esi offset file i think this file sent from attacker)
-and the call fuction `sub_401282` with push eax as int (Knowing that store value of eax in edi and moves value of stack `[esp+10h+arg_4]` in eax) and push [esp+14h+arg_0] as int and push esi as file 
-and call the function `__ftbuf` with push esi and edi (knowing that edi containing the return value of function `__stbuf`).
---
- What is the purpose of this program?
i think it try to know the state the internet in order to take a feedback.

`Lab6-02`

- What operation does the first subroutine called by main perform?
![](/PNG/6-2-0.PNG)
`sub_401000` there is the first subroutine in main
![](/PNG/6-2-1.PNG)
uses windows API `InternetGetConnectedState` to know the status of the Internet, where if the return value is true, this means that it is connected to the Internet, and if it is false, this means that it is not connected to the Internet 
---
- What is the subroutine located at 0x40117F?
![](/PNG/6-2-2.PNG)
-he is call a function `__stbuf` with push edi and esi (he moves in esi offset file i think this file sent from attacker)
-and the call fuction `sub_4013A2` with push eax as int (Knowing that store value of eax in edi and moves value of stack `[esp+10h+arg_4]` in eax) and push [esp+14h+arg_0] as int and push esi as file 
-and call the function `__ftbuf` with push esi and edi (knowing that edi containing the return value of function `__stbuf`).
---
- What does the second subroutine called by main do?
![](/PNG/6-2-3.PNG)
`sub_401040` there is the second subroutine in main
![](/PNG/6-2-4.PNG)
-he uses the windows API `InternetOpenA` that the returns a valid handle that the application passes to subsequent WinINet functions. If InternetOpen fails, it returns NULL
-and uses the windows API `InternetOpenUrlA` that the returns a valid handle to the URL if the connection is successfully established, or NULL if the connection fails
-he is try to connection the internet by means of internet explorer and open the website `http://www.practicalmalwareanalysis.com/cc.htm` in order to read some files and doing malicious things.
---
- What type of code construct is used in this subroutine?
![](/PNG/6-2-5.PNG)
-I htink it's `if` condition because frequent use of comparisons with jumping
---
- Are there any network-based indicators for this program?
![](/PNG/6-2-6.PNG)
IOCs : `http://www.practicalmalwareanalysis.com/cc.htm`
---
- What is the purpose of this malware?
he is try know state of the internet in order to open the internet explorer and the open website `http://www.practicalmalwareanalysis.com/cc.htm` and read some files and doing the malicious activites.

`Lab6-03`

- Compare the calls in main to Lab 6-2’s main method. What is the new function called from main?
![](/PNG/6-3-0.PNG)
`sub_401130` there is the new function in main
---
- What parameters does this new function take?
![](/PNG/6-3-1.PNG)
`lpExistingFileName` : The current name of the file or directory on the local computer
`char`
---
- What major code construct does this function contain?
![](/PNG/6-3-2.PNG)
This is definitely a `switch case`.
![](/PNG/6-3-3.PNG)
click on the `tab` will decompile automatically.
---
- What can this function do?
It depends on the input char value. If it is `a`, then it creates directories, if it is `b`, it copies the file, if it is `c`, it deletes the file, if it is `d`, it opens the registry key and then executes the other of the malicious instructions, and if it is `e`, it creates sleep mode for a certain period of time.
---
- Are there any host-based indicators for this malware?
![](/PNG/6-3-4.PNG)
IOCs : `C:\Temp\cc.exe`
registry key : `Software\Microsoft\Windows\CurrentVersion\Run`
---
- What is the purpose of this malware? 
he is try know state of the internet in order to open the internet explorer and the open website `http://www.practicalmalwareanalysis.com/cc.htm` and read some files and try to set the registry key `Software\Microsoft\Windows\CurrentVersion\Run` and manipulating files, whether deleting them or creating other files.

`Lab6-04`

- What is the difference between the calls made from the main method in Labs 6-3 and 6-4?
![](/PNG/6-4-2.PNG)
![](/PNG/6-4-0.PNG)
---
- What new code construct has been added to main?
![](/PNG/6-4-1.PNG)
ooops! this means that the code is repeated 1440 times 
---
- What is the difference between this lab’s parse HTML function and those of the previous labs?
![](/PNG/6-4-3.PNG)
i think the different in the number of variables and arguments and he is print the `Internet Explorer 7.50/pma%d` knowing that `%d` is the input and there is the counter. this is mean will print the message 1440 times.
---
- How long will this program run? (Assume that it is connected to the Internet.)
he is the excute the code 1440 times and into the code he is sleep 60000 millisecond 
![](/PNG/6-4-4.PNG) try to claculate this :
1440 * 1 minute(60 second(60000 millisecond)) = 1440 minute 
`1 hour = 60 minute --> ? hour = 1440 minute`
the time will this program run is = (1440*1)/60 = 24 hours = 1 days
---
- Are there any new network-based indicators for this malware?
IOCs : `Internet Explorer 7.50/pma%d`
Internet Explorer 7.50/pma1 .... Internet Explorer 7.50/pma1440
---
- What is the purpose of this malware?
It does the same lab6-03 but this works all day.



Thanks 
